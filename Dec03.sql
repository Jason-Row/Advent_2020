/**ADVENT OF CODE DEC 03**/
--Create Table

CREATE TABLE ADVENT_DEC03_HILL (id_num int IDENTITY(1,1), HILL_TXT NVARCHAR(100))

INSERT INTO ADVENT_DEC03_HILL (HILL_TXT)
--VALUES ('..##.......'), ('#...#...#..'), ('.#....#..#.'), ('..#.#...#.#'), ('.#...##..#.'), ('..#.##.....'), ('.#.#.#....#'), ('.#........#'), ('#.##...#...'), ('#...##....#'), ('.#..#...#.#') -- test values
VALUES('........#....#..##..#...#.....#'), ('...............#....##........#'), ('.#....##...##..#...............'), ('.#.......#......#.##..##...#...'), ('.....#.#....#..##...#.....#....'), ('...#.#..##...###......#..#..#.#'), ('.....#..##........#.##......#..'), ('..##.....###.........##........'), ('..............##..#.#.#.#......'), ('.#....##..#.##.#....#..#.#..#..'), ('.#.#....#.##.#...#....#.....#..'), ('..#...#.#.....#....#.......##..'), ('.#.#..##.....#...........#.....'), ('.#.##...#.....#......#.##......'), ('..#..#..........#.....#..###.#.'), ('##....##....#.#...........#..#.'), ('.....#.#.......#.#.#..#.##....#'), ('...##.#....#..#.....#.........#'), ('.....#........#.##...#.........'), ('.....#................#.#...#..'), ('...#....##.....##....#.......#.'), ('....##.#.....#.#.......#.......'), ('#...............#..#...........'), ('.......###.#.......#.##....#.#.'), ('..#........###........#......#.'), ('.#.......#...##.....####....##.'), ('..##.#....#.....#..#....#......'), ('..#...#..#.#..##...#.....#.....'), ('.#.......###.......#....#......'), ('...#...#.......#........#...#.#'), ('..#....#...#.......#.#..##.....'), ('##............#.#..#..........#'), ('.......###...##..#.....#....#..'), ('##..######.#..#.......###....##'), ('###..#...#.##......##....#...#.'), ('..............##.###..........#'), ('.....#........##.#.###....#....'), ('..#...#.....##.#......#.#..#.#.'), ('#....#.............#.#.........'), ('.........##.#........#...#.....'), ('..........#..##.#.#.....#..##..'), ('........##......#..#..#...#.#..'), ('.##.......#..#.#...#.####..#...'), ('##...#........#.###...##....#..'), ('....###.####...#..#..#......###'), ('#....#....#.#.....##.........#.'), ('#.......#....#....##...........'), ('##...##.#.......#....#...#....#'), ('....#....#........##..#.#..#.#.'), ('..##.....##...#..........#...#.'), ('.#.#.#...#.....##..#........#..'), ('#....#.....#..........#....#...'), ('...##.#.......#.#.........#....'), ('##.##.........##.....##.....##.'), ('##.#..##..#...##........##.....'), ('.........##.......#....#...#...'), ('.#.....#........####.#.#.....#.'), ('...........##..#.###...........'), ('..#....##....#...#.............'), ('#.#............#.......#.......'), ('.##........#...#..##.....#.#...'), ('#.##..............##..##.......'), ('##.........#......#......#..#..'), ('##.#....#...#....##....#..#.##.'), ('......#...#..#.#...#.#....#.##.'), ('##.......#.....#.........#.....'), ('...##...#................#.#...'), ('....#.####...#.#.....##....##.#'), ('#...#..#.#.##................##'), ('.........##.....##...#..#......'), ('......####....#.##.#.....#.....'), ('...#..#.#....#.#.#..#..........'), ('.....#........##...#.##....#.#.'), ('..##......#...................#'), ('.....#..#...............#..#...'), ('....#........#..#.#...##...#.##'), ('..#.#.......#.##.........#...#.'), ('...##......#.#.................'), ('.#....#...#.............##.#...'), ('........#.##...#..#...###.....#'), ('#....#.#........##....#......##'), ('.###.......#..#..........#..#..'), ('#....#..#....#........#...#...#'), ('##.#.###.##.#...##.#......#.#.#'), ('#..#..#..##........#..###.#...#'), ('....#..#..#.....#...##....#...#'), ('.......##.......#..#.##...##..#'), ('.##....#..###................##'), ('#...#.##.##...#.##......##.....'), ('...##.....##..##...#..#........'), ('...............##.....##.......'), ('.#..#.#..#....#.....#..#...#...'), ('.#....#..#........#.#...#.....#'), ('##.....####..#......#..........'), ('........#.........#.........#..'), ('#...####....#.##...#....#...##.'), ('.#....####..#...##..#......####'), ('...........##.##..#.##...##....'), ('..#..#.......#.##....#.#...#.##'), ('#...........#..#...............'), ('.......#.##..#.....##......#...'), ('....##.#.##.....#...........#.#'), ('.............#.##..#...#......#'), ('#......#...........#........#..'), ('#.#..#.............#...#.......'), ('#.........##...#....#...##.....'), ('##...#..#..#..#....#...........'), ('.#.....#........#.....#.##..#.#'), ('...#..............##.####.#..#.'), ('##.....#..#.#..#..##...........'), ('...#...#.......#...............'), ('..#..................###..#..##'), ('....###..........#.#..#...#.#.#'), ('..#..#..#.#..........#.#......#'), ('....#....#.#...#.###...##..#...'), ('....#.......#...#....##........'), ('.#.....#.......###....#........'), ('....#..#..#.....#......#.......'), ('......#...#..#....#.#.......#..'), ('.##.#..#...#.#.#...........#...'), ('..#....##.#....#.#....#...#.#.#'), ('...##..#.......#....#.#.....##.'), ('##.#......#.#.......##...#.....'), ('......#...#.##..............#..'), ('.##.........#......##.#..#....#'), ('#.......#.....#...##...#..#...#'), ('..#..##.......#......#......##.'), ('#..##...###.#.#...........#....'), ('##......#.....####..#..#....#.#'), ('.......##...##.#...#...........'), ('....#..#.##.#.....#.#....#.#...'), ('....#.....#.....####...#..#.##.'), ('.##..#..#..###...#....#.##.#.#.'), ('..#.#.##..........##...........'), ('#.##.#.#....#.##....#..#...##.#'), ('#...#....#...###....#.......#..'), ('.......#..#............#.......'), ('................##.#.#.....#..#'), ('..........................#....'), ('.##....##...#.#....####..#....#'), ('......#...#....#...#.##..###.#.'), ('.........#............#.......#'), ('.#.#..#........#..#.........#..'), ('#..#...#......#.#....#..#.#....'), ('...........#.................#.'), ('.#.#..#...##..###......##....##'), ('.#.#.##......####.........##...'), ('..#....#.#..#................#.'), ('##.......#....#.........##.#.#.'), ('##..#.###...........#..#.#..#.#'), ('...#............##.#....#......'), ('...#................##.#..#....'), ('....#..##.#...#.#.....#.......#'), ('......#......#.#........#..##..'), ('...##...#.....#.##.......#.....'), ('##...#...#.............#..#....'), ('..#...##.....#..........#..#.##'), ('#.##...#..................#.###'), ('.........#..........#.###...#.#'), ('#..#.....#.#.#....#......#...#.'), ('.............#.##..###.....#.##'), ('..#..#.....#..#.............#..'), ('.#.....##.#.#..#.........#.....'), ('..#.......#....#.....##.#......'), ('.#.........#..#....##...#.##...'), ('.##..##................###....#'), ('.#..##..............#...#......'), ('.#..............#.##....##.....'), ('.#......#..#..##..#...###.....#'), ('................##...#.#..#...#'), ('##.#.......#...................'), ('....#.#.......#..#.##..........'), ('....###............##...#......'), ('.......#....#.#.....##.#.....#.'), ('....#...............#.#........'), ('..#.##....#.#.#......##..#.....'), ('.##......#...#.#..#..#.......#.'), ('....#...#........#.#..##.......'), ('.##...###.#....#..........##..#'), ('..#.......##..#.....###......#.'), ('...#.#..##.#.#...........#.....'), ('##........#.#..##.........#..#.'), ('.....###.......#..#.#.....##.#.'), ('..#...##.#..............#......'), ('......#...#...............##.#.'), ('##...#..#....#...#.####.##.....'), ('...#............#.##...........'), ('...#........##.#.##.......#....'), ('...#..#..##....#...#......#..#.'), ('#.....#..#......#.#.....##.#.#.'), ('.....#.##......#...#..#..###..#'), ('...........##..##.#.#..........'), ('...#........##........##..##.#.'), ('......###...#.....#..###.#..#..'), ('#.....#.#....#...##....##.....#'), ('.##....#......#.....#.#..##.##.'), ('##....###.......#...##.......##'), ('...##......#....###............'), ('..#...#...#.#..#..........##.#.'), ('#.#.###...#..#.....#....#.###..'), ('..##.....#.#.#.......#.........'), ('...####..#....#..#.........#...'), ('.##...........#.##.#...#.#.##..'), ('...#.#....#.##......#........#.'), ('##....##....#..#...#..#.#......'), ('#......#..#...#...#.#.#.#.####.'), ('....##.#.#.....#.###........#..'), ('....##..#.#.#.#....#....#.#..#.'), ('..#.###..#............##..#.#..'), ('...#...#..#...#.#.#.....#.....#'), ('..........#.....#..#.......##.#'), ('..............##...........#...'), ('.......#.....#...#.....#.....#.'), ('.#.###.....##......##....#...#.'), ('.....#.........#.#....#........'), ('..#.#....#.##...#.##....##...#.'), ('...#......#.#.....#.......###..'), ('#.##....##.....#.#.#...#......#'), ('#..#...#..........#.........##.'), ('....#.#.#.#.....#...###........'), ('#.#..#...#......#...#.##...####'), ('.#...#......#....##...#........'), ('..#.........#............#...#.'), ('##......#..#...#....#.##....#..'), ('.#...##..#..##.#.#.#........#.#'), ('.##.........###...#......#..###'), ('...##.....##..#.#.........#....'), ('...........##........#...#.....'), ('..##..#...#..#..#.....#......#.'), ('..#..#.#....#.....#..#.##...#..'), ('#....#........##..........#.###'), ('......#...#...#....#...##.#....'), ('...#......#.#.....##......##...'), ('#....#..##............#....#.#.'), ('...#...##.#..........##........'), ('......#.###......#...#.#.......'), ('..................#.##..#..#..#'), ('....#.....#...#.....#...#....#.'), ('.#....##.#..#..#.....###.##...#'), ('#.......#..#....##.##.#.....##.'), ('..##........##...#.....#....##.'), ('#.........#...........##.#.....'), ('.#....#.#...##..###..........#.'), ('....##..##....####...#......#..'), ('##.##..#..#....#....####...#...'), ('..#...............#.##.........'), ('...#.#....#..#....#......#.....'), ('.#..#...#........#...#.....##..'), ('#.....###.......#.....#........'), ('...#.##..#.......#....#........'), ('....##..###.##...#.#....#.#....'), ('#.####...#.......#.....#.#....#'), ('#.......#......#.......#.#.#...'), ('##....#......#..#...#..#..####.'), ('.##.....#........#..#...#......'), ('#.#.#....#....#...#.##..##.....'), ('....#..#.........###.##.##.....'), ('...##...##.###..#..##.....#.###'), ('..###.......................#..'), ('......##..#.#.........#......#.'), ('.###......##....#.....#.......#'), ('.....#..#..##........#......##.'), ('..##.....#....#.#.............#'), ('..##.........##.#..#.........##'), ('......#......#.#......#........'), ('.#...#..#......##...#..#....#..'), ('...............###............#'), ('#.####.#....#...#...........#.#'), ('............................#.#'), ('.#..#...#.#.#.###..##.....##...'), ('....##...#.................##..'), ('......##....#...............##.'), ('.#......#.##.#..#.....##...##..'), ('.............#........#......#.'), ('#..........#.#....#####.#...#.#'), ('.#.#...##..#.#...#.#..#.#..#...'), ('#.##.......##......#.#.#....#..'), ('##.....##.#.#.##..........##..#'), ('....##..#.#.......#....#.##....'), ('..#.#.#...#.....#.......#......'), ('.#....#..#...........###.......'), ('#.#...#.....#......#...#.....#.'), ('#........#.#..........#...#.#..'), ('...#...#....#.........#........'), ('.....................#..##.....'), ('...#......##........#.##.#.#.##'), ('.............###...#.#...#..#..'), ('.#..##........##....#...###..##'), ('.#..#.#...............#.....##.'), ('...........##.#....#..##.#....#'), ('.##.#.#..#.#..#...#.#.#..#.#.##'), ('.......#.#..#..#..#..#...#.....'), ('.#......##............#.#..#...'), ('..#...#..##..#..#...##......#..'), ('...##......##....#............#'), ('.......#.....##...##.#...#..#..'), ('......#.......#..##.........#..'), ('..#...#.#.....#.#.......#.#...#'), ('.#......##.##.#.#.#.##..#....##'), ('#.....#.........#.#....#....##.'), ('.......#.........#....#..#.#.##'), ('.....##....#..#.#.#...#.....##.'), ('#####.#.......######......#....'), ('..##.#.......#.#..............#'), ('..#.##....#.....#...#.#...##...'), ('.....#...#..#....#.#..#........'), ('.#....#.#..#.#.#.##..#.......#.'), ('....#..#..#..........##...#....'), ('.......#.#......#........#.....'), ('##.#.#.###....##.#..#..#....#..'), ('#.##......#..#.......#.#...#...'), ('..##...#.......#.......#...#...'), ('........##.........#.#....#.#..'), ('..#...#..##.#.#.#...#....#.....'), ('.###......#........#....#...#..'), ('.#.......##......###..##.......'), ('#....#.#....#.##.........####..'), ('......#..........#..##.....#...'), ('.............#......#..##.#....'), ('...................#....#...#..'), ('.#..........#...#.#..##...#....'), ('.....#...#..........##.##......'), ('#...#..#.##........#...#.......')
GO

/**ADVENT OF CODE DEC 03 PART 1**/

DECLARE @COL_LEN INT
DECLARE @ROW_CNT INT

SET @COL_LEN = (SELECT MAX(LEN(HILL_TXT)) AS COL_LEN
				FROM ADVENT_DEC03_HILL)

SET @ROW_CNT = (SELECT COUNT(*) FROM ADVENT_DEC03_HILL)

SELECT	SUM(CASE	WHEN 
					CASE	WHEN ((ID_NUM - 1)*3+1) % @COL_LEN = 0
							THEN SUBSTRING(HILL_TXT, @COL_LEN, 1) 
							ELSE SUBSTRING(HILL_TXT, ((ID_NUM - 1)*3+1) % @COL_LEN,1)
							END = '.'
					THEN 0
					ELSE 1
					END) AS TREE_QTY
FROM ADVENT_DEC03_HILL
GO													

/**ADVENT OF CODE DEC 03 PART 2**/
--Create Slopes Table
CREATE TABLE ADVENT_DEC03_SLOPES (ID_NUM INT IDENTITY(1,1), RIGHT_QTY INT, DOWN_QTY INT);

INSERT INTO ADVENT_DEC03_SLOPES (RIGHT_QTY, DOWN_QTY)
VALUES (1,1), (3,1), (5,1), (7,1), (1,2)
GO

--Code
DECLARE @COL_LEN INT
DECLARE @ROW_CNT INT

SET @COL_LEN = (SELECT MAX(LEN(HILL_TXT)) AS COL_LEN
				FROM ADVENT_DEC03_HILL)

SET @ROW_CNT = (SELECT COUNT(*) FROM ADVENT_DEC03_HILL)

select EXP(SUM(LOG(FINAL.TREE_QTY))) AS FINAL_PRODUCT
from
(
SELECT	HILL_SUB.SLOPE_ID_NUM
		,HILL_SUB.RIGHT_QTY
		,HILL_SUB.DOWN_QTY
		,SUM(  CASE	WHEN 
								CASE	WHEN ((HILL_SUB.HILL_ROW - 1)*HILL_SUB.RIGHT_QTY+1) % @COL_LEN = 0
										THEN SUBSTRING(HILL_TXT, @COL_LEN, 1) 
										ELSE SUBSTRING(HILL_TXT, ((HILL_SUB.HILL_ROW - 1)*HILL_SUB.RIGHT_QTY+1) % @COL_LEN,1)
										END = '.'
								THEN 0
								ELSE 1
								END) AS TREE_QTY 
				
FROM (
		SELECT	ADVENT_DEC03_SLOPES.ID_NUM AS SLOPE_ID_NUM
				,ADVENT_DEC03_SLOPES.RIGHT_QTY
				,ADVENT_DEC03_SLOPES.DOWN_QTY
				,ADVENT_DEC03_HILL.ID_NUM AS HILL_ID_NUM
				,ROW_NUMBER() OVER (PARTITION BY ADVENT_DEC03_SLOPES.ID_NUM ORDER BY ADVENT_DEC03_SLOPES.ID_NUM ASC, ADVENT_DEC03_HILL.ID_NUM ASC) AS HILL_ROW
				,ADVENT_DEC03_HILL.HILL_TXT
				
				 FROM ADVENT_DEC03_HILL, ADVENT_DEC03_SLOPES
		WHERE (ADVENT_DEC03_HILL.ID_NUM - 1) % ADVENT_DEC03_SLOPES.DOWN_QTY = 0

) AS HILL_SUB

		group by HILL_SUB.SLOPE_ID_NUM
		,HILL_SUB.RIGHT_QTY
		,HILL_SUB.DOWN_QTY
		) AS FINAL
GO
--Clean-up
DROP TABLE ADVENT_DEC03_HILL;
DROP TABLE ADVENT_DEC03_SLOPES;